name: Auto Build and Release

on:
  push:
    branches: [main]
    # ç§»é™¤äº† tags å’Œ pr çš„è§¦å‘ï¼Œé¿å…é‡å¤æ„å»ºæˆ–éä¸»åˆ†æ”¯å‘å¸ƒ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # å¿…é¡»èµ‹äºˆå†™æƒé™æ‰èƒ½åˆ›å»º Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Get Short SHA
        id: vars
        run: |
          # æˆªå– GITHUB_SHA çš„å‰7ä½
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "Current commit hash: ${GITHUB_SHA::7}"

      - name: Build with Maven
        run: mvn clean package

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          # ä¸Šä¼  target ç›®å½•ä¸‹æ‰€æœ‰çš„ jar æ–‡ä»¶ï¼ˆæ’é™¤ original- å¼€å¤´çš„ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰
          artifacts: "target/MobLaunch-*.jar"
          # æ’é™¤ maven shade æ’ä»¶ç”Ÿæˆçš„åŸå§‹æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œçœ‹ä½ çš„pomé…ç½®ï¼‰
          # å¦‚æœä½ çš„jaråŒ…åå­—æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç›´æ¥å†™æ­»ï¼Œæ¯”å¦‚ target/MobLaunch-1.4.0.jar

          # Release çš„æ ‡é¢˜å’Œ Tag éƒ½ä½¿ç”¨çŸ­å“ˆå¸Œ
          name: "Build ${{ env.SHORT_SHA }}"
          tag: "${{ env.SHORT_SHA }}"

          # å¦‚æœè¿™ä¸ª Tag ä¸å­˜åœ¨ï¼ŒAction ä¼šè‡ªåŠ¨åˆ›å»º
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

          body: |
            ## è‡ªåŠ¨æ„å»ºç‰ˆæœ¬: ${{ env.SHORT_SHA }}

            æ­¤ç‰ˆæœ¬ç”± GitHub Actions åœ¨æäº¤ ${{ env.SHORT_SHA }} åè‡ªåŠ¨æ„å»ºã€‚

            ### ğŸ› ï¸ å˜æ›´ä¿¡æ¯
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}

            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ä¸‹æ–¹çš„ JAR æ–‡ä»¶
            2. æ”¾å…¥æœåŠ¡å™¨ plugins æ–‡ä»¶å¤¹
            3. é‡å¯æœåŠ¡å™¨
