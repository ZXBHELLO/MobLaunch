name: Auto Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      # --- æ–°å¢æ­¥éª¤ï¼šè·å– Commit ä¿¡æ¯ ---
      - name: Get Commit Details
        id: details
        run: |
          # 1. è·å–çŸ­å“ˆå¸Œ
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

          # 2. è·å–å®Œæ•´çš„ Commit Message (å¤„ç†å¤šè¡Œæ–‡æœ¬)
          # ä½¿ç”¨ EOF å†™å…¥æ³•é˜²æ­¢ç‰¹æ®Šå­—ç¬¦ç ´å YAML ç»“æ„
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build with Maven
        run: mvn clean package

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "target/MobLaunch-*.jar"
          name: "Build ${{ env.SHORT_SHA }}"
          tag: "${{ env.SHORT_SHA }}"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

          # --- ä¿®æ”¹éƒ¨åˆ†ï¼šç¾åŒ–æ›´æ–°æ—¥å¿— ---
          body: |
            ## ğŸ¤– è‡ªåŠ¨æ„å»ºç‰ˆæœ¬: ${{ env.SHORT_SHA }}

            ### ğŸ“ æ›´æ–°æ—¥å¿— (Change Log)

            ```text
            ${{ env.COMMIT_MSG }}
            ```

            ---

            ### â„¹ï¸ æ„å»ºä¿¡æ¯
            - **æäº¤è€…**: @${{ github.actor }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            - **å“ˆå¸Œ**: ${{ github.sha }}

            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ä¸‹æ–¹çš„ `MobLaunch-*.jar` æ–‡ä»¶
            2. æ”¾å…¥æœåŠ¡å™¨ `plugins` æ–‡ä»¶å¤¹
            3. é‡å¯æœåŠ¡å™¨
